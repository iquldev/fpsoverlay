name: Build and Publish

on: 
  push:
    branches: 
    - main
    tags:
    - 'v*.*.*'

jobs:
  build-1-20:
    name: üß± Build 1.20.6
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: '1.20.6'

    steps:
    - name: üì• Checkout
      uses: actions/checkout@v3
      
    - name: ‚òï Installing Java
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 21
        
    - name: üì¶ Ca—Åhing Gradle
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-1.20.6-${{ hashFiles('1.20.6/**/*.gradle*', '1.20.6/**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-1.20.6

    - name: üîì Allow gradlew
      run: chmod +x gradlew
          
    - name: üõ†Ô∏è Build
      run: ./gradlew build

    - name: üì§ JAR 1.20
      uses: actions/upload-artifact@v4
      with:
        name: mod-1.20.6
        path: 1.20.6/build/libs/*.jar

  build-1-21:
    name: üß± Build 1.21 Mod
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: '1.21'

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v3

      - name: ‚òï Installing Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: üì¶ Ca—Åhing Gradle
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-1.21-${{ hashFiles('1.21/**/*.gradle*', '1.21/**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-1.21

      - name: üîì Allow gradlew
        run: chmod +x gradlew

      - name: üõ†Ô∏è Build
        run: ./gradlew build

      - name: üì§ JAR 1.21
        uses: actions/upload-artifact@v4
        with:
          name: mod-1.21
          path: 1.21/build/libs/*.jar
          
  release:
    name: üöÄ Create Release with Changelog
    needs: [build-1-20, build-1-21]
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        
      - name: üîñ Fetch tags and history
        run: |
          git fetch --prune --unshallow || true
          git fetch --tags
  
      - name: üîç Get previous tag
        id: prev_tag
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 $(git rev-list --tags --skip=1 --max-count=1) || echo "")
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT
  
      - name: üìù Generate changelog from commits
        id: changelog
        run: |
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          if [ -z "${{ steps.prev_tag.outputs.prev_tag }}" ]; then
            echo "* First release! üéâ" >> $GITHUB_OUTPUT
          else
            git log ${{ steps.prev_tag.outputs.prev_tag }}..HEAD --pretty=format:"* %s (%an)" >> $GITHUB_OUTPUT
          fi
          echo "EOF" >> $GITHUB_OUTPUT
  
      - name: üì• Download build artifacts 1.20.6
        uses: actions/download-artifact@v3
        with:
          name: mod-1.20.6
          path: ./1.20.6/build/libs
  
      - name: üì• Download build artifacts 1.21
        uses: actions/download-artifact@v3
        with:
          name: mod-1.21
          path: ./1.21/build/libs
  
      - name: üöÄ Create GitHub Release with JAR files
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "Release ${{ github.ref_name }} üéâ"
          body: ${{ steps.changelog.outputs.changelog }}
          files: |
            1.20.6/build/libs/mod-1.20.6.jar
            1.21/build/libs/mod-1.21.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  modrinth:
    name: üéØ Publish to Modrinth
    needs: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Publish 1.20.6 to Modrinth
        uses: Modrinth/modrinth-publish-action@v1
        with:
          api_token: ${{ secrets.MODRINTH_TOKEN }}
          project_id: ${{ secrets.MODRINTH_PROJECT_ID }}
          version_number: ${{ github.ref_name }}-1.20.6
          loaders: fabric
          game_versions: 
            1.20
            1.20.1
            1.20.2
            1.20.3
            1.20.4
            1.20.5
            1.20.6
          release_type: release
          file: 1.20.6/build/libs/*.jar

      - name: Publish 1.21 to Modrinth
        uses: Modrinth/modrinth-publish-action@v1
        with:
          api_token: ${{ secrets.MODRINTH_TOKEN }}
          project_id: ${{ secrets.MODRINTH_PROJECT_ID }}
          version_number: ${{ github.ref_name }}-1.21
          loaders: fabric
          game_versions: 
            1.21
            1.21.1
            1.21.2
            1.21.3
            1.21.4
            1.21.5
          release_type: release
          file: 1.21/build/libs/*.jar

  curseforge:
    name: üìú Publish to CurseForge
    needs: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Publish 1.20.6 to CurseForge
        uses: curseforge/curseforge-upload@v1
        with:
          api-key: ${{ secrets.CF_API_KEY }}
          project-id: ${{ secrets.CF_PROJECT_ID }}
          file: 1.20.6/build/libs/*.jar
          release-type: release
          changelog: "Automated release ${{ github.ref_name }} for MC 1.20.6"
          display-name: "${{ github.ref_name }}-1.20.6"
          game-versions: 1.20, 1.20.1, 1.20.2, 1.20.3, 1.20.4, 1.20.5, 1.20.6
          loaders: 'fabric'

      - name: Publish 1.21 to CurseForge
        uses: curseforge/curseforge-upload@v1
        with:
          api-key: ${{ secrets.CF_API_KEY }}
          project-id: ${{ secrets.CF_PROJECT_ID }}
          file: 1.21/build/libs/*.jar
          release-type: release
          changelog: "Automated release ${{ github.ref_name }} for MC 1.21"
          display-name: "${{ github.ref_name }}-1.21"
          game-versions: 1.21, 1.21.1, 1.21.2, 1.21.3, 1.21.4, 1.21.5
          loaders: 'fabric'
