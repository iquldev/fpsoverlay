name: Build and Publish

on: 
  push:
    branches: 
    - main
    tags:
    - 'v*.*.*'

jobs:
  build-1-20:
    name: ğŸ§± Build 1.20.6
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: '1.20.6'

    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v3
      
    - name: â˜• Installing Java
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 21
        
    - name: ğŸ“¦ CaÑhing Gradle
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-1.20.6-${{ hashFiles('1.20.6/**/*.gradle*', '1.20.6/**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-1.20.6

    - name: ğŸ”“ Allow gradlew
      run: chmod +x gradlew
          
    - name: ğŸ› ï¸ Build
      run: ./gradlew build

    - name: ğŸ“¤ JAR 1.20
      uses: actions/upload-artifact@v4
      with:
        name: mod-1.20.6
        path: 1.20.6/build/libs/*.jar

  build-1-21:
    name: ğŸ§± Build 1.21 Mod
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: '1.21'

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v3

      - name: â˜• Installing Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: ğŸ“¦ CaÑhing Gradle
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-1.21-${{ hashFiles('1.21/**/*.gradle*', '1.21/**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-1.21

      - name: ğŸ”“ Allow gradlew
        run: chmod +x gradlew

      - name: ğŸ› ï¸ Build
        run: ./gradlew build

      - name: ğŸ“¤ JAR 1.21
        uses: actions/upload-artifact@v4
        with:
          name: mod-1.21
          path: 1.21/build/libs/*.jar
          
  release:
    name: ğŸš€ Create Release with Changelog
    needs: [build-1-20, build-1-21]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: ğŸ”– Fetch all tags
        run: git fetch --prune --unshallow --tags

      - name: ğŸ“ Generate Changelog
        id: gen_notes
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.RELEASE_TOKEN }}
          script: |
            const tag = context.ref.replace('refs/tags/','');
            const { data } = await github.rest.repos.generateReleaseNotes({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag
            });
            return data.body;

      - name: ğŸ“¦ Create GitHub Release
        id: create_release
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.RELEASE_TOKEN }}
          script: |
            const tag = context.ref.replace('refs/tags/','');
            const notes = `# Changelog for ${tag}\n\n${`${{ steps.gen_notes.outputs.result }}`}`;
            const release = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag,
              name: `Release ${tag}`,
              body: notes,
              draft: false,
              prerelease: false
            });
            return release.data.upload_url;

      - name: ğŸ“¤ Upload 1.20.6 JAR
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.result }}
          asset_path: 1.20.6/build/libs/*.jar
          asset_name: fpsoverlay-${{ github.ref_name }}-1.20.6.jar
          asset_content_type: application/java-archive

      - name: ğŸ“¤ Upload 1.21 JAR
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.result }}
          asset_path: 1.21/build/libs/*.jar
          asset_name: fpsoverlay-${{ github.ref_name }}-1.21.jar
          asset_content_type: application/java-archive

  modrinth:
    name: ğŸ¯ Publish to Modrinth
    needs: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Publish 1.20.6 to Modrinth
        uses: Modrinth/modrinth-publish-action@v1
        with:
          api_token: ${{ secrets.MODRINTH_TOKEN }}
          project_id: ${{ secrets.MODRINTH_PROJECT_ID }}
          version_number: ${{ github.ref_name }}-1.20.6
          loaders: fabric
          game_versions: 1.20.6
          release_type: release
          file: 1.20.6/build/libs/*.jar

      - name: Publish 1.21 to Modrinth
        uses: Modrinth/modrinth-publish-action@v1
        with:
          api_token: ${{ secrets.MODRINTH_TOKEN }}
          project_id: ${{ secrets.MODRINTH_PROJECT_ID }}
          version_number: ${{ github.ref_name }}-1.21
          loaders: fabric
          game_versions: 1.21
          release_type: release
          file: 1.21/build/libs/*.jar

  curseforge:
    name: ğŸ“œ Publish to CurseForge
    needs: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Publish 1.20.6 to CurseForge
        uses: curseforge/curseforge-upload@v1
        with:
          api-key: ${{ secrets.CF_API_KEY }}
          project-id: ${{ secrets.CF_PROJECT_ID }}
          file: 1.20.6/build/libs/*.jar
          release-type: release
          changelog: "Automated release ${{ github.ref_name }} for MC 1.20.6"
          display-name: "${{ github.ref_name }}-1.20.6"
          game-versions: '1.20.6'
          loaders: 'fabric'

      - name: Publish 1.21 to CurseForge
        uses: curseforge/curseforge-upload@v1
        with:
          api-key: ${{ secrets.CF_API_KEY }}
          project-id: ${{ secrets.CF_PROJECT_ID }}
          file: 1.21/build/libs/*.jar
          release-type: release
          changelog: "Automated release ${{ github.ref_name }} for MC 1.21"
          display-name: "${{ github.ref_name }}-1.21"
          game-versions: '1.21'
          loaders: 'fabric'
